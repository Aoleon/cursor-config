import { z } from "zod";
import { createInsertSchema } from "drizzle-zod";

// ========================================
// Types d'√©v√©nements m√©tier prioritaires
// ========================================

export enum EventType {
  // AOs (Appels d'Offres)
  AO_CREATED = 'ao.created',
  AO_STATUS_CHANGED = 'ao.status_changed',
  
  // Offres
  OFFER_STATUS_CHANGED = 'offer.status_changed',
  OFFER_SIGNED = 'offer.signed',
  OFFER_VALIDATED = 'offer.validated',
  OFFER_CREATED = 'offer.created',
  OFFER_UPDATED = 'offer.updated',
  
  // Projets  
  PROJECT_CREATED = 'project.created',
  PROJECT_UPDATED = 'project.updated',
  PROJECT_STATUS_CHANGED = 'project.status_changed',
  PROJECT_TASK_ASSIGNED = 'project.task_assigned',
  
  // T√¢ches
  TASK_OVERDUE = 'task.overdue', 
  TASK_STATUS_CHANGED = 'task.status_changed',
  TASK_DEADLINE_APPROACHING = 'task.deadline_approaching',
  
  // Validations
  VALIDATION_MILESTONE_VALIDATED = 'validation_milestone.validated',
  VALIDATION_MILESTONE_REJECTED = 'validation_milestone.rejected',
  
  // Chiffrage
  CHIFFRAGE_COMPLETED = 'chiffrage.completed',
  SUPPLIER_QUOTE_RECEIVED = 'supplier_quote.received',
  
  // KPIs & Syst√®me
  KPI_REFRESH_HINT = 'kpi.refresh_hint',
  SYSTEM_MAINTENANCE = 'system.maintenance',
  
  // Fournisseurs
  SUPPLIER_REQUEST_SENT = 'supplier_request.sent',
  SUPPLIER_RESPONSE_RECEIVED = 'supplier_response.received',
  
  // Priorit√©s intelligentes
  PRIORITY_SCORE_UPDATED = 'priority.score_updated',
  PRIORITY_LEVEL_CHANGED = 'priority.level_changed',
  PRIORITY_OVERRIDE_APPLIED = 'priority.override_applied',
  PRIORITY_ALERT_CREATED = 'priority.alert_created',
  PRIORITY_CONFIG_UPDATED = 'priority.config_updated',
  
  // M√©triques et performances
  WORKLOAD_UPDATED = 'workload.updated',
  PERFORMANCE_METRICS_UPDATED = 'performance.metrics_updated',
  HOURS_VARIANCE_ALERT = 'hours.variance_alert',
  ESTIMATION_ACCURACY_ALERT = 'estimation.accuracy_alert',
  
  // Gantt et planification
  GANTT_TASK_MOVED = 'gantt.task_moved',
  GANTT_TASK_RESIZED = 'gantt.task_resized',
  GANTT_DEPENDENCY_CREATED = 'gantt.dependency_created',
  GANTT_MILESTONE_CREATED = 'gantt.milestone_created',
  
  // Alertes techniques OCR
  TECHNICAL_ALERT = 'technical.alert',
  
  // Intelligence temporelle et planification
  DATE_INTELLIGENCE_TIMELINE_CALCULATED = 'date_intelligence.timeline_calculated',
  DATE_INTELLIGENCE_CASCADE_RECALCULATED = 'date_intelligence.cascade_recalculated', 
  DATE_INTELLIGENCE_RULE_APPLIED = 'date_intelligence.rule_applied',
  DATE_INTELLIGENCE_ALERT_CREATED = 'date_intelligence.alert_created',
  DATE_INTELLIGENCE_ALERT_ACKNOWLEDGED = 'date_intelligence.alert_acknowledged',
  DATE_INTELLIGENCE_ALERT_RESOLVED = 'date_intelligence.alert_resolved',
  DATE_INTELLIGENCE_PLANNING_ISSUE_DETECTED = 'date_intelligence.planning_issue_detected',
  
  // Analytics et m√©triques consolid√©es
  ANALYTICS_CALCULATED = 'analytics.calculated',
  
  // === NOUVEAUX TYPES ALERTES M√âTIER ===
  BUSINESS_ALERT_CREATED = 'business_alert.created',
  BUSINESS_ALERT_ACKNOWLEDGED = 'business_alert.acknowledged', 
  BUSINESS_ALERT_RESOLVED = 'business_alert.resolved',
  BUSINESS_ALERT_DISMISSED = 'business_alert.dismissed',
  BUSINESS_ALERT_ASSIGNED = 'business_alert.assigned',
  
  ALERT_THRESHOLD_CREATED = 'alert_threshold.created',
  ALERT_THRESHOLD_UPDATED = 'alert_threshold.updated',
  ALERT_THRESHOLD_DEACTIVATED = 'alert_threshold.deactivated',
  
  // √âv√©nements d√©clencheurs √©valuation seuils
  PREDICTIVE_SNAPSHOT_SAVED = 'predictive.snapshot_saved',
  
  // √âv√©nements chatbot et apprentissage adaptatif
  CHATBOT_QUERY_PROCESSED = 'chatbot.query_processed',
  CHATBOT_FEEDBACK_RECEIVED = 'chatbot.feedback_received',
  
  // Batigest ERP Synchronization
  BATIGEST_EXPORT_QUEUED = 'batigest.export_queued',
  BATIGEST_EXPORT_SYNCED = 'batigest.export_synced',
  BATIGEST_EXPORT_ERROR = 'batigest.export_error'
}

// ========================================
// Interfaces Payloads √âv√©nements Alertes M√©tier
// ========================================

// √âv√©nement cr√©ation alerte business
export interface BusinessAlertCreatedPayload {
  alert_id: string;
  alert_type: string;        // 'profitability', 'team_overload', etc.
  entity_type: string;       // 'project', 'team', etc.
  entity_id: string;
  entity_name: string;
  severity: string;          // 'info', 'warning', 'error', 'critical'
  title: string;
  message: string;
  threshold_value?: number;
  actual_value?: number;
  variance?: number;
  triggered_at: string;      // ISO timestamp
  threshold_id?: string;
  context_data?: Record<string, unknown>;
}

// √âv√©nement acknowledgment alerte
export interface BusinessAlertAcknowledgedPayload {
  alert_id: string;
  acknowledged_by: string;   // User ID
  acknowledged_at: string;   // ISO timestamp
  notes?: string;
  previous_status: string;
  new_status: 'acknowledged';
}

// √âv√©nement r√©solution alerte
export interface BusinessAlertResolvedPayload {
  alert_id: string;
  resolved_by: string;       // User ID
  resolved_at: string;       // ISO timestamp
  resolution_notes: string;
  previous_status: string;
  new_status: 'resolved';
  resolution_duration_minutes?: number; // Temps r√©solution
}

// √âv√©nement dismissal alerte
export interface BusinessAlertDismissedPayload {
  alert_id: string;
  dismissed_by: string;      // User ID
  dismissed_at: string;      // ISO timestamp
  dismissal_reason?: string;
  previous_status: string;
  new_status: 'dismissed';
}

// √âv√©nement assignation alerte
export interface BusinessAlertAssignedPayload {
  alert_id: string;
  assigned_to: string;       // User ID assign√©
  assigned_by: string;       // User ID qui assigne
  assigned_at: string;       // ISO timestamp
  previous_assigned_to?: string;
}

// √âv√©nement configuration seuil
export interface AlertThresholdCreatedPayload {
  threshold_id: string;
  threshold_key: string;     // 'profitability_margin', etc.
  operator: string;          // 'less_than', 'greater_than', etc.
  threshold_value: number;
  scope_type: string;        // 'global', 'project', etc.
  scope_entity_id?: string;
  severity: string;
  created_by: string;        // User ID
  is_active: boolean;
  notification_channels: string[];
}

export interface AlertThresholdUpdatedPayload {
  threshold_id: string;
  updated_by: string;        // User ID
  updated_at: string;        // ISO timestamp
  changes: Record<st, unknown>unknown>; // Champs modifi√©s
  was_active: boolean;
  is_active: boolean;
}

export interface AlertThresholdDeactivatedPayload {
  threshold_id: string;
  deactivated_by: string;    // User ID
  deactivated_at: string;    // ISO timestamp
  reason?: string;
}

// √âv√©nement d√©clencheur √©valuation pr√©dictive
export interface PredictiveSnapshotSavedPayload {
  snapshot_id: string;
  calculation_type: string;  // 'revenue_forecast', 'risk_analysis', etc.
  calculated_at: string;
  values: Record<string, number>;
  triggers_evaluation: boolean;
  confidence_score?: number;
}

// ========================================
// Union Type EventPayload Extended
// ========================================

export type EventPayload = 
  // Payloads alertes m√©tier
  | BusinessAlertCreatedPayload
  | BusinessAlertAcknowledgedPayload
  | BusinessAlertResolvedPayload
  | BusinessAlertDismissedPayload
  | BusinessAlertAssignedPayload
  | AlertThresholdCreatedPayload
  | AlertThresholdUpdatedPayload
  | AlertThresholdDeactivatedPayload
  | PredictiveSnapshotSavedPayload;

// ========================================
// Schema √©v√©nement temps r√©el
// ========================================

export const realtimeEventSchema = z.object({
  id: z.string().uuid(),
  type: z.nativeEnum(EventType),
  entity: z.enum(['ao', 'appel_offres', 'offer', 'project', 'task', 'validation', 'supplier', 'system', 'technical', 'date_intelligence', 'business_alert', 'alert_threshold', 'batigest', 'analytics']),
  entityId: z.string(),
  
  // Relations pour navigation et contexte
  projectId: z.string().optional(),
  offerId: z.string().optional(),
  taskId: z.string().optional(),
  
  // Informations de changement d'√©tat
  prevStatus: z.string().optional(),
  newStatus: z.string().optional(),
  
  // M√©tadonn√©es de notification
  severity: z.enum(['info', 'warning', 'success', 'error', 'critical']),
  message: z.string(),
  title: z.string().optional(),
  
  // Pour invalidation cache cibl√©e TanStack Query
  affectedQueryKeys: z.array(z.array(z.string())),
  
  // M√©tadonn√©es syst√®me
  timestamp: z.string().datetime(),
  userId: z.string().optional(), // Pour filtrage futur
  
  // Donn√©es additionnelles contextuelles
  metadata: z.record(z.string(), z.unknown()).optional(),
});

export type RealtimeEvent = z.infer<typeof realtimeEventSchema>;

// ========================================
// Schema pour filtrage des √©v√©nements
// ========================================

export const eventFilterSchema = z.object({
  eventTypes: z.array(z.nativeEnum(EventType)).optional(),
  entities: z.array(z.string()).optional(),
  entityIds: z.array(z.string()).optional(),
  projectIds: z.array(z.string()).optional(),
  offerIds: z.array(z.string()).optional(),
  severities: z.array(z.enum(['info', 'warning', 'success', 'error', 'critical'])).optional(),
  userId: z.string().optional(),
});

export type EventFilter = z.infer<typeof eventFilterSchema>;

// ========================================
// Messages WebSocket
// ========================================

export const wsMessageSchema = z.discriminatedUnion('type', [
  // √âv√©nement temps r√©el
  z.object({
    type: z.literal('event'),
    data: realtimeEventSchema,
  }),
  
  // Heartbeat
  z.object({
    type: z.literal('ping'),
    timestamp: z.string().datetime(),
  }),
  
  z.object({
    type: z.literal('pong'),
    timestamp: z.string().datetime(),
  }),
  
  // Authentification
  z.object({
    type: z.literal('auth'),
    token: z.string().optional(),
  }),
  
  z.object({
    type: z.literal('auth_success'),
    userId: z.string(),
  }),
  
  z.object({
    type: z.literal('auth_error'),
    message: z.string(),
  }),
  
  // Souscription aux √©v√©nements
  z.object({
    type: z.literal('subscribe'),
    filter: eventFilterSchema.optional(),
  }),
  
  z.object({
    type: z.literal('unsubscribe'),
  }),
  
  // Erreurs syst√®me
  z.object({
    type: z.literal('error'),
    message: z.string(),
    code: z.string().optional(),
  }),
]);

export type WsMessage = z.infer<typeof wsMessageSchema>;

// ========================================
// Templates de messages m√©tier
// ========================================

export const eventMessageTemplates: Record<EventType, (event: RealtimeEvent) => { title: string; message: string }> = {
  [EventType.AO_CREATED]: (event) => ({
    title: "Nouvel AO",
    message: `üìã Nouvel appel d'offre cr√©√© : ${event.metadata?.reference || event.entityId}`
  }),
  
  [EventType.AO_STATUS_CHANGED]: (event) => ({
    title: "Statut AO modifi√©",
    message: `üìã AO ${event.metadata?.reference || event.entityId} : ${event.prevStatus} ‚Üí ${event.newStatus}`
  }),
  
  [EventType.OFFER_SIGNED]: (event) => ({
    title: "Offre sign√©e",
    message: `‚úÖ L'offre ${event.metadata?.reference || event.entityId} a √©t√© sign√©e par le client`
  }),
  
  [EventType.OFFER_VALIDATED]: (event) => ({
    title: "Validation termin√©e",
    message: `üéØ Validation fin d'√©tudes termin√©e pour l'offre ${event.metadata?.reference || event.entityId}`
  }),
  
  [EventType.OFFER_STATUS_CHANGED]: (event) => ({
    title: "Statut offre modifi√©",
    message: `üìã Offre ${event.metadata?.reference || event.entityId} : ${event.prevStatus} ‚Üí ${event.newStatus}`
  }),
  
  [EventType.PROJECT_CREATED]: (event) => ({
    title: "Nouveau projet",
    message: `üöÄ Nouveau projet cr√©√© : ${event.metadata?.name || event.entityId}`
  }),
  
  [EventType.PROJECT_UPDATED]: (event) => ({
    title: "Projet mis √† jour",
    message: `üìù Projet ${event.metadata?.name || event.entityId} mis √† jour depuis ${event.metadata?.source || 'l\'application'}`
  }),
  
  [EventType.PROJECT_STATUS_CHANGED]: (event) => ({
    title: "Statut projet modifi√©",
    message: `üìä Projet ${event.metadata?.name || event.entityId} : ${event.prevStatus} ‚Üí ${event.newStatus}`
  }),
  
  [EventType.TASK_OVERDUE]: (event) => ({
    title: "T√¢che en retard",
    message: `‚ö†Ô∏è T√¢che en retard : ${event.metadata?.name || event.entityId} (${event.metadata?.delayDays || 'N/A'} jours)`
  }),
  
  [EventType.TASK_STATUS_CHANGED]: (event) => ({
    title: "T√¢che mise √† jour",
    message: `‚úì T√¢che ${event.metadata?.name || event.entityId} : ${event.prevStatus} ‚Üí ${event.newStatus}`
  }),
  
  [EventType.TASK_DEADLINE_APPROACHING]: (event) => ({
    title: "√âch√©ance proche",
    message: `üìÖ T√¢che ${event.metadata?.name || event.entityId} due dans ${event.metadata?.daysUntilDue || 'N/A'} jours`
  }),
  
  [EventType.VALIDATION_MILESTONE_VALIDATED]: (event) => ({
    title: "Jalon valid√©",
    message: `‚úÖ Jalon ${event.metadata?.milestoneName || 'validation'} valid√© par ${event.metadata?.validatorName || 'l\'√©quipe'}`
  }),
  
  [EventType.VALIDATION_MILESTONE_REJECTED]: (event) => ({
    title: "Jalon rejet√©",
    message: `‚ùå Jalon ${event.metadata?.milestoneName || 'validation'} rejet√© : ${event.metadata?.reason || 'voir d√©tails'}`
  }),
  
  [EventType.CHIFFRAGE_COMPLETED]: (event) => ({
    title: "Chiffrage termin√©",
    message: `üí∞ Chiffrage termin√© pour l'offre ${event.metadata?.reference || event.entityId}`
  }),
  
  [EventType.SUPPLIER_QUOTE_RECEIVED]: (event) => ({
    title: "Devis fournisseur re√ßu",
    message: `üì¶ Nouveau devis re√ßu de ${event.metadata?.supplierName || 'fournisseur'}`
  }),
  
  [EventType.SUPPLIER_REQUEST_SENT]: (event) => ({
    title: "Demande fournisseur envoy√©e",
    message: `üì§ Demande de prix envoy√©e √† ${event.metadata?.supplierName || 'fournisseur'}`
  }),
  
  [EventType.SUPPLIER_RESPONSE_RECEIVED]: (event) => ({
    title: "R√©ponse fournisseur",
    message: `üì• R√©ponse re√ßue de ${event.metadata?.supplierName || 'fournisseur'}`
  }),
  
  [EventType.KPI_REFRESH_HINT]: (event) => ({
    title: "Donn√©es mises √† jour",
    message: `üìä Les indicateurs ont √©t√© actualis√©s`
  }),
  
  [EventType.SYSTEM_MAINTENANCE]: (event) => ({
    title: "Maintenance syst√®me",
    message: `üîß ${event.message}`
  }),
  
  [EventType.OFFER_CREATED]: (event) => ({
    title: "Nouvelle offre",
    message: `üìã Nouvelle offre cr√©√©e : ${event.metadata?.reference || event.entityId}`
  }),
  
  [EventType.OFFER_UPDATED]: (event) => ({
    title: "Offre mise √† jour",
    message: `üìù Offre ${event.metadata?.reference || event.entityId} mise √† jour depuis ${event.metadata?.source || 'l\'application'}`
  }),
  
  [EventType.PROJECT_TASK_ASSIGNED]: (event) => ({
    title: "T√¢che assign√©e",
    message: `üë§ T√¢che ${event.metadata?.taskName || 'nouvelle'} assign√©e √† ${event.metadata?.assigneeName || 'l\'√©quipe'}`
  }),
  
  // Priorit√©s intelligentes
  [EventType.PRIORITY_SCORE_UPDATED]: (event) => ({
    title: "Score de priorit√© mis √† jour",
    message: `üéØ Score: ${event.metadata?.oldScore || 'N/A'} ‚Üí ${event.metadata?.newScore || 'N/A'} pour ${event.metadata?.itemName || event.entityId}`
  }),
  
  [EventType.PRIORITY_LEVEL_CHANGED]: (event) => ({
    title: "Niveau de priorit√© modifi√©",
    message: `üî∫ Priorit√© ${event.metadata?.itemName || event.entityId}: ${event.prevStatus} ‚Üí ${event.newStatus}`
  }),
  
  [EventType.PRIORITY_OVERRIDE_APPLIED]: (event) => ({
    title: "Priorit√© forc√©e manuellement",
    message: `‚ö° Priorit√© forc√©e pour ${event.metadata?.itemName || event.entityId}: ${event.newStatus} (${event.metadata?.reason || 'Aucune raison'})`
  }),
  
  [EventType.PRIORITY_ALERT_CREATED]: (event) => ({
    title: "Alerte de priorit√© critique",
    message: `üö® Nouvelle alerte critique: ${event.metadata?.itemName || event.entityId} (Score: ${event.metadata?.score || 'N/A'})`
  }),
  
  [EventType.PRIORITY_CONFIG_UPDATED]: (event) => ({
    title: "Configuration priorit√© mise √† jour",
    message: `‚öôÔ∏è R√®gles de priorisation mises √† jour par ${event.metadata?.updatedBy || 'admin'}`
  }),
  
  // M√©triques et performances  
  [EventType.WORKLOAD_UPDATED]: (event) => ({
    title: "Charge de travail mise √† jour",
    message: `üìä Charge BE mise √† jour: ${event.metadata?.memberName || '√©quipe'} (${event.metadata?.newLoad || 'N/A'}%)`
  }),
  
  [EventType.PERFORMANCE_METRICS_UPDATED]: (event) => ({
    title: "M√©triques de performance actualis√©es",
    message: `üìà Pr√©cision: ${event.metadata?.accuracy || 'N/A'}% | Productivit√©: ${event.metadata?.productivity || 'N/A'}%`
  }),
  
  [EventType.HOURS_VARIANCE_ALERT]: (event) => ({
    title: "√âcart important d'heures d√©tect√©",
    message: `‚ö†Ô∏è √âcart de ${event.metadata?.variancePercent || 'N/A'}% d√©tect√© pour ${event.metadata?.itemName || event.entityId}`
  }),
  
  [EventType.ESTIMATION_ACCURACY_ALERT]: (event) => ({
    title: "Pr√©cision d'estimation faible",
    message: `üìâ Pr√©cision d'estimation √† ${event.metadata?.accuracy || 'N/A'}% (seuil: ${event.metadata?.threshold || '70'}%)`
  }),
  
  // Gantt et planification
  [EventType.GANTT_TASK_MOVED]: (event) => ({
    title: "T√¢che d√©plac√©e",
    message: `üìÖ ${event.metadata?.taskName || 'T√¢che'} d√©plac√©e: ${event.metadata?.oldDate || 'N/A'} ‚Üí ${event.metadata?.newDate || 'N/A'}`
  }),
  
  [EventType.GANTT_TASK_RESIZED]: (event) => ({
    title: "Dur√©e de t√¢che modifi√©e", 
    message: `‚è±Ô∏è ${event.metadata?.taskName || 'T√¢che'} redimensionn√©e: ${event.metadata?.oldDuration || 'N/A'} ‚Üí ${event.metadata?.newDuration || 'N/A'} jours`
  }),
  
  [EventType.GANTT_DEPENDENCY_CREATED]: (event) => ({
    title: "D√©pendance cr√©√©e",
    message: `üîó D√©pendance cr√©√©e entre ${event.metadata?.fromTask || 't√¢che'} ‚Üí ${event.metadata?.toTask || 't√¢che'}`
  }),
  
  [EventType.GANTT_MILESTONE_CREATED]: (event) => ({
    title: "Nouveau jalon cr√©√©",
    message: `üéØ Jalon "${event.metadata?.milestoneName || 'Nouveau jalon'}" cr√©√© le ${event.metadata?.date || 'N/A'}`
  }),

  // Analytics et m√©triques
  [EventType.ANALYTICS_CALCULATED]: (event) => ({
    title: "M√©triques mises √† jour",
    message: `üìä ${event.message}`
  }),

  // Alertes techniques OCR
  [EventType.TECHNICAL_ALERT]: (event) => ({
    title: "Alerte technique",
    message: `üîß ${event.message}`
  }),

  // Intelligence temporelle et planification
  [EventType.DATE_INTELLIGENCE_TIMELINE_CALCULATED]: (event) => ({
    title: "Planning calcul√©",
    message: `üìÖ Timeline calcul√©e pour ${event.metadata?.projectName || event.entityId} (${event.metadata?.duration || 'N/A'} jours)`
  }),

  [EventType.DATE_INTELLIGENCE_CASCADE_RECALCULATED]: (event) => ({
    title: "Cascade planning recalcul√©e",
    message: `üîÑ Recalcul en cascade effectu√© pour ${event.metadata?.projectName || event.entityId} suite √† ${event.metadata?.trigger || 'modification'}`
  }),

  [EventType.DATE_INTELLIGENCE_RULE_APPLIED]: (event) => ({
    title: "R√®gle m√©tier appliqu√©e",
    message: `üìã R√®gle "${event.metadata?.ruleName || 'm√©tier'}" appliqu√©e √† ${event.metadata?.projectName || event.entityId}`
  }),

  [EventType.DATE_INTELLIGENCE_ALERT_CREATED]: (event) => ({
    title: "Alerte planning cr√©√©e",
    message: `‚ö†Ô∏è ${event.metadata?.alertType || 'Alerte'} d√©tect√©e: ${event.message}`
  }),

  [EventType.DATE_INTELLIGENCE_ALERT_ACKNOWLEDGED]: (event) => ({
    title: "Alerte acquitt√©e",
    message: `‚úÖ Alerte "${event.metadata?.alertType || 'planning'}" acquitt√©e par ${event.metadata?.acknowledgedBy || 'utilisateur'}`
  }),

  [EventType.DATE_INTELLIGENCE_ALERT_RESOLVED]: (event) => ({
    title: "Alerte r√©solue",
    message: `‚úÖ Alerte "${event.metadata?.alertType || 'planning'}" r√©solue: ${event.metadata?.resolutionNote || 'probl√®me corrig√©'}`
  }),

  [EventType.DATE_INTELLIGENCE_PLANNING_ISSUE_DETECTED]: (event) => ({
    title: "Probl√®me de planification d√©tect√©",
    message: `üö® Conflit d√©tect√©: ${event.metadata?.issueDescription || event.message}`
  }),

  // === NOUVEAUX TEMPLATES ALERTES M√âTIER ===
  [EventType.BUSINESS_ALERT_CREATED]: (event) => ({
    title: "üö® Nouvelle alerte m√©tier",
    message: `Alerte ${event.metadata?.alert_type || 'm√©tier'} d√©tect√©e: ${event.metadata?.title || event.message} (S√©v√©rit√©: ${event.metadata?.severity || 'N/A'})`
  }),

  [EventType.BUSINESS_ALERT_ACKNOWLEDGED]: (event) => ({
    title: "‚úÖ Alerte acquitt√©e",
    message: `Alerte ${event.entityId} acquitt√©e par ${event.metadata?.acknowledged_by || 'utilisateur'} ${event.metadata?.notes ? '- ' + event.metadata.notes : ''}`
  }),

  [EventType.BUSINESS_ALERT_RESOLVED]: (event) => ({
    title: "‚úÖ Alerte r√©solue",
    message: `Alerte ${event.entityId} r√©solue par ${event.metadata?.resolved_by || 'utilisateur'} ${event.metadata?.resolution_duration_minutes ? 'en ' + event.metadata.resolution_duration_minutes + ' min' : ''}`
  }),

  [EventType.BUSINESS_ALERT_DISMISSED]: (event) => ({
    title: "‚ùå Alerte ignor√©e",
    message: `Alerte ${event.entityId} ignor√©e par ${event.metadata?.dismissed_by || 'utilisateur'} ${event.metadata?.dismissal_reason ? '- ' + event.metadata.dismissal_reason : ''}`
  }),

  [EventType.BUSINESS_ALERT_ASSIGNED]: (event) => ({
    title: "üë§ Alerte assign√©e",
    message: `Alerte ${event.entityId} assign√©e √† ${event.metadata?.assigned_to || 'utilisateur'} par ${event.metadata?.assigned_by || 'syst√®me'}`
  }),

  [EventType.ALERT_THRESHOLD_CREATED]: (event) => ({
    title: "‚öôÔ∏è Nouveau seuil d'alerte",
    message: `Seuil ${event.metadata?.threshold_key || 'm√©tier'} cr√©√©: ${event.metadata?.threshold_value || 'N/A'} (${event.metadata?.operator || 'condition'}) - S√©v√©rit√©: ${event.metadata?.severity || 'N/A'}`
  }),

  [EventType.ALERT_THRESHOLD_UPDATED]: (event) => ({
    title: "üîß Seuil d'alerte modifi√©",
    message: `Seuil ${event.entityId} mis √† jour par ${event.metadata?.updated_by || 'admin'} ${event.metadata?.activation_changed ? '(activation modifi√©e)' : ''}`
  }),

  [EventType.ALERT_THRESHOLD_DEACTIVATED]: (event) => ({
    title: "üîá Seuil d'alerte d√©sactiv√©",
    message: `Seuil ${event.entityId} d√©sactiv√© par ${event.metadata?.deactivated_by || 'admin'} ${event.metadata?.reason ? '- ' + event.metadata.reason : ''}`
  }),

  [EventType.PREDICTIVE_SNAPSHOT_SAVED]: (event) => ({
    title: "üìä Pr√©diction calcul√©e",
    message: `Snapshot pr√©dictif ${event.metadata?.calculation_type || 'g√©n√©ral'} sauvegard√© ${event.metadata?.triggers_evaluation ? '(d√©clenche √©valuation seuils)' : ''}`
  }),

  // === TEMPLATES CHATBOT ===
  [EventType.CHATBOT_QUERY_PROCESSED]: (event) => ({
    title: "üí¨ Requ√™te chatbot trait√©e",
    message: `Requ√™te trait√©e avec succ√®s ${typeof event.metadata?.query_text === 'string' ? ': "' + event.metadata.query_text.substring(0, 50) + '..."' : ''}`
  }),

  [EventType.CHATBOT_FEEDBACK_RECEIVED]: (event) => ({
    title: "‚≠ê Feedback chatbot re√ßu",
    message: `Feedback ${event.metadata?.rating || 're√ßu'} pour la requ√™te ${event.metadata?.query_id || event.entityId}`
  }),

  // === TEMPLATES BATIGEST ERP ===
  [EventType.BATIGEST_EXPORT_QUEUED]: (event) => ({
    title: "üì§ Export Batigest en attente",
    message: `Export ${event.metadata?.documentType === 'client_quote' ? 'devis client' : 'bon de commande'} mis en queue pour synchronisation`
  }),

  [EventType.BATIGEST_EXPORT_SYNCED]: (event) => ({
    title: "‚úÖ Synchronisation Batigest r√©ussie",
    message: `${event.metadata?.documentType === 'client_quote' ? 'Devis client' : 'Bon de commande'} synchronis√© avec Batigest avec succ√®s`
  }),

  [EventType.BATIGEST_EXPORT_ERROR]: (event) => ({
    title: "‚ùå Erreur synchronisation Batigest",
    message: `Erreur lors de la synchronisation ${event.metadata?.documentType === 'client_quote' ? 'du devis' : 'du bon de commande'}: ${event.metadata?.error || 'erreur inconnue'}`
  }),
};

// ========================================
// Helpers pour cr√©ation d'√©v√©nements
// ========================================

export function createRealtimeEvent(params: {
  type: EventType;
  entity: RealtimeEvent['entity'];
  entityId: string;
  severity: RealtimeEvent['severity'];
  message?: string;
  title?: string;
  affectedQueryKeys: string[][];
  projectId?: string;
  offerId?: string;
  taskId?: string;
  prevStatus?: string;
  newStatus?: string;
  userId?: string;
  metadata?: Recor, unknown>unknunknown>any>;
}): RealtimeEvent {
  const templates = eventMessageTemplates[params.type];
  const generatedMessage = templates ? templates({ ...params, id: '', timestamp: new Date().toISOString() } as RealtimeEvent) : null;
  
  return {
    id: crypto.randomUUID(),
    type: params.type,
    entity: params.entity,
    entityId: params.entityId,
    projectId: params.projectId,
    offerId: params.offerId,
    taskId: params.taskId,
    prevStatus: params.prevStatus,
    newStatus: params.newStatus,
    severity: params.severity,
    message: params.message || generatedMessage?.message || `√âv√©nement ${params.type}`,
    title: params.title || generatedMessage?.title,
    affectedQueryKeys: params.affectedQueryKeys,
    timestamp: new Date().toISOString(),
    userId: params.userId,
    metadata: params.metadata,
  };
}

// Helpers pour query keys communes
export const commonQueryKeys = {
  offers: () => ['/api/offers'],
  offer: (id: string) => ['/api/offers', id],
  projects: () => ['/api/projects'],
  project: (id: string) => ['/api/projects', id],
  tasks: () => ['/api/tasks'],
  task: (id: string) => ['/api/tasks', id],
  dashboardKpis: (filter?: string) => filter ? ['/api/dashboard/kpis', filter] : ['/api/dashboard/kpis'],
  dashboardStats: () => ['/api/dashboard/stats'],
  beWorkload: () => ['/api/be-workload'],
  validationMilestones: (entityType?: string, entityId?: string) => 
    entityType && entityId ? ['/api/validation-milestones', entityType, entityId] : ['/api/validation-milestones'],
  suppliers: () => ['/api/suppliers'],
  supplierRequests: () => ['/api/supplier-requests'],
  
  // Nouvelles query keys pour priorit√©s et m√©triques
  priorities: () => ['/api/priorities'],
  priority: (id: string) => ['/api/priorities', id],
  priorityAlerts: () => ['/api/priorities/alerts'],
  priorityHistory: (itemId: string) => ['/api/priorities', itemId, 'history'],
  priorityStats: () => ['/api/priorities/stats'],
  priorityConfig: () => ['/api/priorities/config'],
  workloadMetrics: (period?: string) => period ? ['/api/workload/performance-history', period] : ['/api/workload/performance-history'],
  projectMetrics: () => ['/api/projects/metrics'],
  
  // === NOUVELLES QUERY KEYS ALERTES M√âTIER ===
  businessAlerts: () => ['/api/alerts', 'business'],
  businessAlert: (id: string) => ['/api/alerts', id],
  businessAlertsByStatus: (status: string) => ['/api/alerts', 'status', status],
  businessAlertsByUser: (userId: string) => ['/api/alerts', 'assigned', userId],
  alertThresholds: () => ['/api/alerts', 'thresholds'],
  alertThreshold: (id: string) => ['/api/alerts', 'thresholds', id],
  alertThresholdsByKey: (key: string) => ['/api/alerts', 'thresholds', key],
  alertSettings: () => ['/api/alerts', 'settings'],
  alertEvaluation: () => ['/api/alerts', 'evaluation', 'trigger'],
  dashboardAlerts: () => ['/api/dashboard', 'alerts'],
  dashboardSettings: () => ['/api/dashboard', 'settings'],
  alertNotifications: (userId?: string) => userId ? ['/api/notifications', userId] : ['/api/notifications', 'alerts'],
  analyticsAlerts: () => ['/api/analytics', 'alerts', 'resolution_metrics'],
};